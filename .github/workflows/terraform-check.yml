# Terraform検証およびフォーマットチェックワークフロー
#
# 目的: プルリクエストおよびプッシュ時に自動的にterraform validateとフォーマットチェックを実行し、
# Terraform設定の品質と一貫したフォーマットを確保する。

name: Terraform Check

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'infra/**'
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
  workflow_dispatch:

defaults:
  run:
    working-directory: infra

jobs:
  terraform-check:
    runs-on: ubuntu-latest
    name: Terraform Validation and Format Check
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Install mise
      uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3

    - name: Verify Terraform version
      run: terraform version

    - name: Initialize Terraform
      # -backend=false フラグは、CI上でバックエンド設定を無視し、プロバイダーのみを初期化するために使用しています。
      # これにより、リモートステートへのアクセス不要でvalidateやfmt等のチェックが可能です。
      run: terraform init -backend=false

    - name: Terraform Format Check
      run: terraform fmt -check -recursive

    - name: Terraform Validation
      run: terraform validate
